# Canvas 钢笔工具设计文档
以下整理出钢笔绘制工具的设计文档，以便于理解其基本结构。

> 项目迭代中，文档描述可能与实际代码不匹配，本文档对应 `8924c5` 提交。


## 主要特性
需要实现的特性主要包括：

* 基于锚点绘制钢笔曲线。
* 锚点可选是否平滑，支持拖拽。
* 同一画布支持多条曲线。
* 可通过点击曲线，在曲线相应位置增加锚点。


## 钢笔算法
钢笔曲线的绘制结合了三种类型的线段：

* 二次曲线
* 贝塞尔曲线
* 直线

一般的平滑曲线绘制并不涉及直线。此处我们选择的交互逻辑与 PS 的钢笔工具不同，它所需要绘制的是「经过用户所点击的 n 个点的路径」。为了在简化的交互中能更好地适应抠图中一些尖锐的转角位置，我们引入**拐角点**（corner point）的概念。曲线中若存在一个拐角点，拐角点两侧的曲线可以理解为分别绘制，在拐角点不保证连续。如果存在连续的多个拐角点，它们之间用直线连接。

若不考虑拐角点的情形，解决**给定 n 个点，绘制经过这些点的平滑曲线**的问题，可参考 [Spline Interpolation](http://scaledinnovation.com/analytics/splines/aboutSplines.html) 一文。它结合了二次曲线和贝塞尔曲线来逐段绘制经过锚点的线段，保证曲线在锚点处的一阶导数连续：

* 每三个相邻的锚点，计算出两个控制点（类比 PS 钢笔控制点）。
* 对开始和结束线段，绘制经过起始点、结束点和一个控制点的二次曲线。
* 对普通线段，绘制经过起始点、结束点和两个控制点的贝塞尔曲线。

对于存在拐角点的情形，扩展后的算法加入了直线的处理逻辑。假设曲线中的线段两端点为 A 与 B，有如下情形：

1. 若线段 AB 为起始或结束线段，那么：
  1. 若 A 为起始点，那么线段 AB 为二次曲线（B 非结束点）或直线（B 为拐角点）。
  2. 若 B 为结束点，那么线段 AB 为二次曲线（A 非开始点）或直线（A 为拐角点）。
3. 若 AB 在整条曲线中间位置，那么：
  1. A、B 均为普通点，绘制贝塞尔曲线。
  2. A、B 有一个拐角点，绘制二次曲线。
  3. A、B 均为拐角点，绘制直线。


## 对象模型
在 [Konva](konvajs.github.io/docs/) 的对象模型基础上实现的主要 class 实例包括：

### `App`
封装 Konva 的 stage 与 layer 对象，暴露统一的 `draw` 方法，并将其注入每个 FlexLine 与 Point 对象中。


### `FlexLine`
存储一系列 Point 数组作为数据源，它基于数据源生成每个线段的 `segments` getter 数据，使用其逐段绘制曲线。

在每段 segment 中，除可获得到该线段的 `from: Point` 与 `to: Point` 端点外，还包含了对线段前驱点 `prev: Point?` 与后继点 `next: Point?` 的引用，以此作为判断绘制类型的依据。

### `Point`
封装每个锚点的 UI 样式，为其绑定事件。每个锚点均有到其父级 FlexLine 的引用，在触发拖拽、点击等事件时，调用 FlexLine 相应方法完成曲线的更新。
